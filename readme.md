# åŸºäº DETR çš„äº¤é€šæ ‡å¿—ä¸è½¦è¾†å¤šç›®æ ‡æ£€æµ‹ç³»ç»Ÿ

2026 å±Šæœ¬ç§‘æ¯•ä¸šè®ºæ–‡å·¥ç¨‹æºç 
é¢˜ç›®ï¼š**åŸºäº DETR çš„äº¤é€šæ ‡å¿—ä¸è½¦è¾†å¤šç›®æ ‡æ£€æµ‹ç³»ç»Ÿçš„è®¾è®¡ä¸å®ç°**
å…³é”®è¯ï¼šDeformable DETRï¼Œå°ç›®æ ‡æ£€æµ‹ï¼Œå¤šç›®æ ‡è·Ÿè¸ªï¼ŒStreamlit å¯è§†åŒ–

---

## ğŸ“‹ é¡¹ç›®å½“å‰çŠ¶æ€ï¼ˆ2026-01-03æ›´æ–°ï¼‰

### âœ… å·²å®Œæˆï¼ˆç¬¬1-2æ­¥ï¼šæ•°æ®å‡†å¤‡é˜¶æ®µï¼‰

#### 1ï¸âƒ£ é¡¹ç›®æ¶æ„æ­å»º
- âœ… å®Œæ•´ç›®å½•ç»“æ„ï¼š`tools/`, `configs/`, `data/`, `outputs/`
- âœ… é…ç½®ç®¡ç†ç³»ç»Ÿï¼šYAMLæ ¼å¼é…ç½®æ–‡ä»¶
- âœ… æ–‡æ¡£ä½“ç³»ï¼š`docs/develop.md` å¼€å‘æŒ‡å—

#### 2ï¸âƒ£ ç±»åˆ«æ˜ å°„ä¸é…ç½®
- âœ… **configs/classes.yaml**ï¼šå®šä¹‰3ç±»ç²—ç²’åº¦æ˜ å°„
  - `0: vehicle` (car, bus, truck)
  - `1: traffic_sign` (äº¤é€šæ ‡å¿—)
  - `2: traffic_light` (çº¢ç»¿ç¯)
- âœ… å¯é…ç½®é€‰é¡¹ï¼šbike/motorå¹¶å…¥ã€æœ€å°é¢ç§¯è¿‡æ»¤

#### 3ï¸âƒ£ æ•°æ®é›†è½¬æ¢å·¥å…·é“¾
- âœ… **tools/convert_to_coco.py**ï¼šå®Œæ•´è½¬æ¢è„šæœ¬
  - æ”¯æŒæ•°æ®é›†ï¼šBDD100K, CCTSDB, TT100K
  - ç±»åˆ«æ˜ å°„ï¼šåŸå§‹ç±»åˆ« â†’ ç²—ç²’åº¦ç±»åˆ« â†’ class_id
  - ç»Ÿè®¡è¾“å‡ºï¼šæ€»å›¾ç‰‡æ•°/æ ‡æ³¨æ•°/ç±»åˆ«è®¡æ•°
  - æ˜ å°„è®°å½•ï¼šç”Ÿæˆ `mapping.json` ç”¨äºè®ºæ–‡å¤ç°
- âœ… **BDD100K**ï¼šæ”¯æŒ det_20 èšåˆ JSON æˆ–å•å›¾ JSON
- âœ… **CCTSDB**ï¼šæ”¯æŒ VOC XML æ ‡æ³¨æ ¼å¼
- âœ… **TT100K**ï¼šå·²éªŒè¯è½¬æ¢ï¼ˆ6,034 è®­ç»ƒå›¾åƒï¼Œ16,749 æ ‡æ³¨ï¼‰
- âœ… **tools/validate_coco.py**ï¼šæ•°æ®é›†å®Œæ•´æ€§éªŒè¯
- âœ… **tools/smoke_test.py**ï¼šå¿«é€Ÿå†’çƒŸæµ‹è¯•

#### 4ï¸âƒ£ è®­ç»ƒé…ç½®æ¨¡æ¿
- âœ… **configs/detr_baseline.yaml**ï¼šåŸºç¡€è®­ç»ƒé…ç½®
  - æ•°æ®é›†è·¯å¾„ã€ç±»åˆ«æ•°
  - æ¨¡å‹ç»“æ„å‚æ•°ï¼ˆç¼–è§£ç å™¨å±‚æ•°ã€æ³¨æ„åŠ›å¤´ç­‰ï¼‰
  - è®­ç»ƒè¶…å‚æ•°ï¼ˆå­¦ä¹ ç‡ã€batch sizeã€ä¼˜åŒ–å™¨ç­‰ï¼‰
  - å†’çƒŸæµ‹è¯•é…ç½®ï¼ˆ200 iterå¿«é€ŸéªŒè¯ï¼‰
- âœ… **tools/train_detr.py**ï¼šè®­ç»ƒè„šæœ¬æ¡†æ¶

### ğŸš§ è¿›è¡Œä¸­

- â¸ï¸ æ•°æ®é›†ä¸‹è½½ä¸è½¬æ¢ï¼ˆç­‰å¾…BDD100Kæ•°æ®ï¼‰
- â¸ï¸ DETRæ¨¡å‹å®ç°
- â¸ï¸ è®­ç»ƒå¾ªç¯å®ç°

### ğŸ“… å¾…å¼€å‘

- â¬œ æ•°æ®åŠ è½½å™¨ï¼ˆDataset/DataLoaderï¼‰
- â¬œ DETRæ¨¡å‹æ ¸å¿ƒç»„ä»¶ï¼ˆbackbone/transformer/headsï¼‰
- â¬œ è®­ç»ƒä¸è¯„ä¼°æµç¨‹
- â¬œ è·Ÿè¸ªå™¨å°è£…ï¼ˆByteTrack/OC-SORTï¼‰
- â¬œ Streamlitå¯è§†åŒ–ç•Œé¢
- â¬œ å®Œæ•´è¯„æµ‹æµç¨‹

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒå‡†å¤‡

```bash
# 1. è¿›å…¥é¡¹ç›®ç›®å½•
cd /srv/code/detr_traffic_analysis

# 2. æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source .venv/bin/activate

# 3. å®‰è£…ä¾èµ–
pip install pycocotools pyyaml tqdm numpy opencv-python
```

### æ•°æ®å‡†å¤‡ï¼ˆç¬¬1-2æ­¥ï¼‰

```bash
# æŸ¥çœ‹ç±»åˆ«æ˜ å°„é…ç½®
cat configs/classes.yaml

# ============================================================
# 1ï¸âƒ£ BDD100K æ•°æ®é›†è½¬æ¢
# ============================================================
# æ‰§è¡ŒCOCOè½¬æ¢ï¼ˆéœ€è¦å…ˆå‡†å¤‡BDD100Kæ•°æ®ï¼‰
python tools/convert_to_coco.py \
  --dataset bdd100k \
  --src data/raw/bdd100k \
  --dst data/traffic_coco/bdd100k_det \
  --config configs/classes.yaml \
  --splits train val

# éªŒè¯è½¬æ¢ç»“æœ
python tools/smoke_test.py \
  data/traffic_coco/bdd100k_det/annotations/instances_val.json

# è¯¦ç»†éªŒè¯ï¼ˆå¯é€‰ï¼‰
python tools/validate_coco.py \
  --ann-file data/traffic_coco/bdd100k_det/annotations/instances_val.json

# ============================================================
# 2ï¸âƒ£ CCTSDB æ•°æ®é›†è½¬æ¢ï¼ˆä¸­å›½äº¤é€šæ ‡å¿—å°ç›®æ ‡ï¼‰
# ============================================================
# æ•°æ®é›†ç»“æ„ï¼š
#   data/raw/cctsdb/
#     images/train/
#     images/test/
#     labels/xml/
python tools/convert_to_coco.py \
  --dataset cctsdb \
  --src data/raw/cctsdb \
  --dst data/traffic_coco/cctsdb_det \
  --config configs/classes.yaml \
  --splits train test

# éªŒè¯è½¬æ¢ç»“æœ
python tools/smoke_test.py \
  data/traffic_coco/cctsdb_det/annotations/instances_train.json

# ============================================================
# 3ï¸âƒ£ TT100K æ•°æ®é›†è½¬æ¢ï¼ˆå¤§è§„æ¨¡äº¤é€šæ ‡å¿—ï¼‰
# ============================================================
# æ•°æ®é›†ç»“æ„ï¼š
#   data/tt100k/
#     annotations_all.json
#     train/
#     test/
python tools/convert_to_coco.py \
  --dataset tt100k \
  --src data/tt100k \
  --dst data/traffic_coco/tt100k_det \
  --config configs/classes.yaml \
  --splits train test

# éªŒè¯è½¬æ¢ç»“æœ
python tools/smoke_test.py \
  data/traffic_coco/tt100k_det/annotations/instances_train.json
```

### é¢„æœŸè¾“å‡º

è½¬æ¢æˆåŠŸåä¼šç”Ÿæˆï¼š

```
data/traffic_coco/
â”œâ”€â”€ bdd100k_det/
â”‚   â”œâ”€â”€ images/
â”‚   â”‚   â”œâ”€â”€ train/        # è®­ç»ƒé›†å›¾åƒ
â”‚   â”‚   â””â”€â”€ val/          # éªŒè¯é›†å›¾åƒ
â”‚   â”œâ”€â”€ annotations/
â”‚   â”‚   â”œâ”€â”€ instances_train.json  # COCOæ ¼å¼æ ‡æ³¨
â”‚   â”‚   â””â”€â”€ instances_val.json
â”‚   â””â”€â”€ mapping.json      # ç±»åˆ«æ˜ å°„è®°å½•
â”‚
â”œâ”€â”€ cctsdb_det/
â”‚   â”œâ”€â”€ images/
â”‚   â”‚   â”œâ”€â”€ train/
â”‚   â”‚   â””â”€â”€ test/
â”‚   â”œâ”€â”€ annotations/
â”‚   â”‚   â”œâ”€â”€ instances_train.json
â”‚   â”‚   â””â”€â”€ instances_test.json
â”‚   â””â”€â”€ mapping.json
â”‚
â””â”€â”€ tt100k_det/
    â”œâ”€â”€ images/
    â”‚   â”œâ”€â”€ train/
    â”‚   â””â”€â”€ test/
    â”œâ”€â”€ annotations/
    â”‚   â”œâ”€â”€ instances_train.json
    â”‚   â””â”€â”€ instances_test.json
    â””â”€â”€ mapping.json
```

å†’çƒŸæµ‹è¯•è¾“å‡ºç¤ºä¾‹ï¼š

**BDD100K**:
```
âœ… åŠ è½½æˆåŠŸ!
   å›¾åƒæ•°: 10,000
   æ ‡æ³¨æ•°: 65,432
   ç±»åˆ«æ•°: 3
   ç±»åˆ«æ˜ å°„: {0: 'vehicle', 1: 'traffic_sign', 2: 'traffic_light'}
   
   ç±»åˆ«åˆ†å¸ƒ:
     [0] vehicle: 57,890
     [1] traffic_sign: 6,234
     [2] traffic_light: 1,308
```

**TT100K** (å·²éªŒè¯):
```
âœ… åŠ è½½æˆåŠŸ!
   å›¾åƒæ•°: 6,034
   æ ‡æ³¨æ•°: 16,749
   ç±»åˆ«æ•°: 3
   ç±»åˆ«æ˜ å°„: {0: 'vehicle', 1: 'traffic_sign', 2: 'traffic_light'}
   
   ç±»åˆ«åˆ†å¸ƒ:
     [0] vehicle: 0
     [1] traffic_sign: 16,749
     [2] traffic_light: 0
```

---

## 1. é¡¹ç›®æ¦‚è§ˆ

### 1.1 é¡¹ç›®ç®€ä»‹

æœ¬é¡¹ç›®å›´ç»•è‡ªåŠ¨é©¾é©¶å’Œé«˜çº§é©¾é©¶è¾…åŠ©ç³»ç»Ÿï¼ˆADASï¼‰ä¸­çš„äº¤é€šåœºæ™¯æ„ŸçŸ¥ä»»åŠ¡ï¼Œè®¾è®¡å¹¶å®ç°äº†ä¸€å¥—åŸºäº **Deformable DETR** çš„äº¤é€šæ ‡å¿—ä¸è½¦è¾†å¤šç›®æ ‡æ£€æµ‹ç³»ç»Ÿã€‚ç³»ç»Ÿä»¥è½¦è½½ç¬¬ä¸€è§†è§’è§†é¢‘ä¸ºä¸»è¦è¾“å…¥ï¼Œå®ç°ï¼š

* äº¤é€šæ ‡å¿—ä¸è½¦è¾†çš„å¤šç±»åˆ«ç›®æ ‡æ£€æµ‹ï¼›
* å¯¹æ£€æµ‹ç»“æœçš„è·¨å¸§å¤šç›®æ ‡è·Ÿè¸ªä¸è½¨è¿¹ç”Ÿæˆï¼›
* åŸºäº Streamlit çš„äº¤äº’å¼å¯è§†åŒ–ä¸ Failure Case åˆ†æã€‚

è¯¥ç³»ç»Ÿæ—¢æ˜¯æ¯•ä¸šè®ºæ–‡çš„å·¥ç¨‹å®ç°è½½ä½“ï¼Œä¹Ÿæ˜¯åç»­ç®—æ³•è°ƒè¯•ä¸å®éªŒå¤ç°çš„å¹³å°ã€‚

### 1.2 ç ”ç©¶èƒŒæ™¯ä¸ç—›ç‚¹

* **å°ç›®æ ‡é—®é¢˜**ï¼šè¿œè·ç¦»äº¤é€šæ ‡å¿—åœ¨å›¾åƒä¸­ä»…å å°‘é‡åƒç´ ï¼Œæ˜“è¢«èƒŒæ™¯æ·¹æ²¡ï¼›
* **é®æŒ¡ä¸æ‹¥å µ**ï¼šåŸå¸‚é“è·¯ä¸­è½¦è¾†å¯†é›†ã€é®æŒ¡é¢‘ç¹ï¼Œæ˜“å‡ºç°æ¼æ£€ä¸ ID é¢‘ç¹åˆ‡æ¢ï¼›
* **å¯è§£é‡Šæ€§éœ€æ±‚**ï¼šåœ¨è‡ªåŠ¨é©¾é©¶ç ”å‘æµç¨‹ä¸­ï¼Œç ”å‘äººå‘˜éœ€è¦ç›´è§‚åœ°è§‚å¯Ÿæ£€æµ‹ä¸è·Ÿè¸ªè¡Œä¸ºï¼Œåˆ†æå¤±è´¥æ ·æœ¬ã€‚

æœ¬é¡¹ç›®é€šè¿‡å¤šå°ºåº¦å¯å˜å½¢æ³¨æ„åŠ›ã€æ•°æ®å¢å¼ºã€åœ¨çº¿å¤šç›®æ ‡è·Ÿè¸ªä¸å¯è§†åŒ–åˆ†æç­‰æ‰‹æ®µï¼Œå¯¹ä¸Šè¿°é—®é¢˜è¿›è¡Œç³»ç»Ÿæ€§æ¢ç´¢ä¸å·¥ç¨‹å®ç°ã€‚

### 1.3 é¡¹ç›®ç›®æ ‡

* **æ£€æµ‹å±‚é¢**ï¼šå®ç°å¯¹è½¦è¾†ä¸äº¤é€šæ ‡å¿—çš„é«˜ç²¾åº¦æ£€æµ‹ï¼Œå°¤å…¶å…³æ³¨å°ç›®æ ‡ AP æå‡ï¼›
* **è·Ÿè¸ªå±‚é¢**ï¼šåœ¨è§†é¢‘åºåˆ—ä¸­ä¿æŒç›®æ ‡ ID çš„æ—¶åºä¸€è‡´æ€§ï¼Œå‡è½»è½¨è¿¹æ–­è£‚ä¸ ID åˆ‡æ¢ï¼›
* **ç³»ç»Ÿå±‚é¢**ï¼šæ„å»ºå¯äº¤äº’çš„å¯è§†åŒ–åˆ†æå·¥å…·ï¼Œæ”¯æŒä¹¦ç­¾ã€å›æ”¾ã€æ•°æ®å¯¼å‡ºä¸æ€§èƒ½è¯„æµ‹ï¼›
* **è®ºæ–‡æ”¯æ’‘**ï¼šä¸ºæ¯•ä¸šè®ºæ–‡ç¬¬ 4 ç« ï¼ˆç³»ç»Ÿå®ç°ï¼‰ä¸ç¬¬ 5 ç« ï¼ˆå®éªŒéªŒè¯ï¼‰æä¾›å®Œæ•´çš„å·¥ç¨‹åŸºç¡€ä¸å®éªŒé—­ç¯ã€‚

---

## 2. ç³»ç»ŸåŠŸèƒ½

### 2.1 æ£€æµ‹ä¸å°ç›®æ ‡ä¼˜åŒ–

* æ”¯æŒå¯¹ä»¥ä¸‹ç±»åˆ«è¿›è¡Œæ£€æµ‹ï¼ˆå¯æ ¹æ®æ•°æ®é›†é…ç½®ï¼‰ï¼š

  * è½¦è¾†ç±»ï¼šCarã€Truckã€Bus ç­‰ï¼›
  * äº¤é€šæ ‡å¿—ç±»ï¼šTraffic Signï¼ˆå¯è¿›ä¸€æ­¥ç»†åˆ†æˆ–åˆå¹¶ç±»åˆ«ï¼‰ã€‚
* åŸºäº Deformable DETR å®ç°ç«¯åˆ°ç«¯ç›®æ ‡æ£€æµ‹ï¼š

  * ç¼–è§£ç å™¨ç»“æ„æ‰¿æ‹…å…¨å±€å»ºæ¨¡ä¸æ³¨æ„åŠ›èšåˆï¼›
  * ä½¿ç”¨å¤šå°ºåº¦ç‰¹å¾ï¼ˆå¦‚ P2â€“P5ï¼‰å¢å¼ºå°ç›®æ ‡æ„ŸçŸ¥èƒ½åŠ›ã€‚
* é’ˆå¯¹å°ç›®æ ‡çš„ä¸“é¡¹ä¼˜åŒ–ï¼š

  * å¯ç”¨å¤šå°ºåº¦è®­ç»ƒï¼ˆmulti-scale trainingï¼‰ï¼›
  * åœ¨é…ç½®ä¸­æ˜¾å¼å¢åŠ é«˜åˆ†è¾¨ç‡ç‰¹å¾å±‚å‚ä¸æ³¨æ„åŠ›è®¡ç®—ï¼›
  * é…åˆæ•°æ®å¢å¼ºï¼ˆéšæœºç¼©æ”¾ä¸è£å‰ªï¼‰æå‡æ¨¡å‹å¯¹ä¸åŒå°ºåº¦çš„é²æ£’æ€§ã€‚

### 2.2 å¤šç›®æ ‡è·Ÿè¸ª

* é›†æˆåœ¨çº¿å¤šç›®æ ‡è·Ÿè¸ªç®—æ³•ï¼ˆå¦‚ ByteTrack / OC-SORT å°è£…ï¼‰ï¼š

  * æ¥æ”¶æ¯å¸§æ£€æµ‹ç»“æœï¼ˆbbox + score + classï¼‰ï¼›
  * è¾“å‡ºå¸¦æœ‰ track_id çš„ç¨³å®šè½¨è¿¹ï¼›
* æ”¯æŒåœ¨æ¼æ£€ã€é®æŒ¡åœºæ™¯ä¸‹ç»´æŒ ID ç¨³å®šæ€§ï¼›
* è¾“å‡ºæ ¼å¼å…¼å®¹ TrackEval å·¥å…·ï¼Œå¯ç”¨äºè®¡ç®— HOTAã€IDF1ã€MOTA ç­‰æŒ‡æ ‡ã€‚

### 2.3 äº¤äº’å¼å¯è§†åŒ–ï¼ˆStreamlitï¼‰

* åŸºäº Streamlit å®ç° Web ç«¯å¯è§†åŒ–ç•Œé¢ï¼š

  * ä¸Šä¼ /é€‰æ‹©æµ‹è¯•è§†é¢‘ï¼›
  * è®¾ç½®æ£€æµ‹é˜ˆå€¼ã€è·Ÿè¸ªç®—æ³•ã€æ˜¯å¦æ˜¾ç¤ºè½¨è¿¹ç­‰ï¼›
  * å®æ—¶å åŠ æ˜¾ç¤ºè¾¹ç•Œæ¡†ã€ç±»åˆ«ã€ç½®ä¿¡åº¦ä¸å†å²è½¨è¿¹çº¿ã€‚
* ä¹¦ç­¾ä¸å›æ”¾åŠŸèƒ½ï¼š

  * åœ¨å…³é”®å¸§æ·»åŠ ä¹¦ç­¾ï¼ˆframe_id + å¤‡æ³¨ä¿¡æ¯ï¼‰ï¼›
  * é€šè¿‡ä¾§è¾¹æ ä¹¦ç­¾åˆ—è¡¨å¿«é€Ÿè·³è½¬è‡³å¯¹åº”å¸§å¹¶å›æ”¾ä¸Šä¸‹æ–‡ç‰‡æ®µã€‚
* ç»“æœå¯¼å‡ºï¼š

  * å¯¼å‡ºåŒ…å«æ£€æµ‹ + è·Ÿè¸ªç»“æœçš„ CSV / JSONï¼›
  * å¯¼å‡ºå åŠ å¯è§†åŒ–ç»“æœçš„è§†é¢‘æ–‡ä»¶ï¼ˆå¸¦æ¡†å›æ”¾ï¼‰ã€‚

### 2.4 æ€§èƒ½è¯„ä¼°

é¡¹ç›®æ”¯æŒå¦‚ä¸‹ä¸‰ç±»æŒ‡æ ‡çš„è¯„æµ‹å’Œå¯¼å‡ºï¼š

* **æ£€æµ‹æŒ‡æ ‡**ï¼š

  * mAP@0.5:0.95ï¼ˆç»¼åˆç²¾åº¦ï¼‰ï¼›
  * AP_smallï¼ˆå°ç›®æ ‡ç²¾åº¦ï¼‰ï¼›
* **è·Ÿè¸ªæŒ‡æ ‡**ï¼š

  * HOTAã€IDF1ã€MOTAï¼›
* **ç³»ç»ŸæŒ‡æ ‡**ï¼š

  * FPSï¼ˆååé‡ï¼‰ã€ç«¯åˆ°ç«¯ Latencyï¼ˆå•å¸§æ—¶å»¶ï¼‰ã€å³°å€¼ VRAMï¼ˆæ˜¾å­˜å ç”¨ï¼‰ã€‚

---

## 3. ç³»ç»Ÿæ¶æ„ä¸ç›®å½•ç»“æ„

æœ¬ç³»ç»Ÿé‡‡ç”¨ã€Œå‰ç«¯â€“åç«¯åˆä¸€ã€æ¶æ„ï¼š

* åç«¯ï¼šPyTorch å®ç°çš„ Deformable DETR æ¨ç†å¼•æ“ä¸å¤šç›®æ ‡è·Ÿè¸ªæ¨¡å—ï¼›
* å‰ç«¯ï¼šStreamlit å®ç°çš„ Web ç•Œé¢ä¸äº¤äº’é€»è¾‘ï¼›
* å·¥å…·å±‚ï¼šæ•°æ®é›†è½¬æ¢ã€ç¦»çº¿è¯„æµ‹ä¸æ€§èƒ½åŸºå‡†æµ‹è¯•è„šæœ¬ã€‚

### 3.1 æ¨¡å—åˆ’åˆ†

* `app/`ï¼šStreamlit å‰ç«¯åº”ç”¨ä¸äº¤äº’é€»è¾‘ï¼ˆSession State ç®¡ç†ã€ä¹¦ç­¾åˆ—è¡¨ç­‰ï¼‰ï¼›
* `models/`ï¼šDeformable DETR æ¨¡å‹æ„å»ºä¸æ¨ç†å°è£…ï¼›
* `tracker/`ï¼šå¤šç›®æ ‡è·Ÿè¸ªå™¨å°è£…ï¼ˆByteTrack / OC-SORTï¼‰ï¼›
* `viz/`ï¼šå¯è§†åŒ–ç»˜åˆ¶æ¨¡å—ï¼ˆåŸºäº OpenCVï¼Œå¯¹å›¾ç‰‡ç»˜åˆ¶ bbox/è½¨è¿¹ç­‰ï¼‰ï¼›
* `video_io/`ï¼šè§†é¢‘è§£ç ä¸é€å¸§è¯»å–ã€å¸§å·è·³è½¬ï¼›
* `tools/`ï¼šæ•°æ®è½¬æ¢ã€è®­ç»ƒã€è¯„æµ‹ã€æ¨ç†ä¸æ€§èƒ½æµ‹è¯•è„šæœ¬ï¼›
* `configs/`ï¼šæ¨¡å‹ä¸è®­ç»ƒé…ç½®æ–‡ä»¶ï¼ˆå«å°ç›®æ ‡ä¼˜åŒ–ç‰ˆæœ¬ï¼‰ï¼›
* `data/`ï¼šæ•°æ®é›†å­˜æ”¾ç›®å½•ï¼ˆåŸå§‹ + COCO è½¬æ¢åï¼‰ï¼›
* `outputs/`ï¼šè®­ç»ƒæ—¥å¿—ã€æ¨¡å‹æƒé‡ã€è¯„æµ‹ç»“æœã€æ¨ç†å¯¼å‡ºç­‰ï¼›
* `experiments/`ï¼ˆå¯é€‰ï¼‰ï¼šå®éªŒè®°å½•ã€é…ç½®å¿«ç…§ä¸è®ºæ–‡å›¾è¡¨ã€‚

### 3.2 ç›®å½•ç»“æ„ç¤ºä¾‹

```text
â”œâ”€â”€ app/
â”‚   â””â”€â”€ app_streamlit.py       # Streamlit ä¸»å…¥å£
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ detr_backbone.py
â”‚   â”œâ”€â”€ detr_heads.py
â”‚   â”œâ”€â”€ build_model.py
â”‚   â””â”€â”€ __init__.py
â”œâ”€â”€ tracker/
â”‚   â”œâ”€â”€ base_tracker.py
â”‚   â”œâ”€â”€ bytetrack_wrapper.py
â”‚   â”œâ”€â”€ ocsort_wrapper.py
â”‚   â””â”€â”€ utils.py
â”œâ”€â”€ viz/
â”‚   â””â”€â”€ drawer.py
â”œâ”€â”€ video_io/
â”‚   â””â”€â”€ video_reader.py
â”œâ”€â”€ tools/
â”‚   â”œâ”€â”€ convert_to_coco.py
â”‚   â”œâ”€â”€ train_detr.py
â”‚   â”œâ”€â”€ eval_detr.py
â”‚   â”œâ”€â”€ inference_tracks.py
â”‚   â”œâ”€â”€ eval_mot.py
â”‚   â””â”€â”€ benchmark_system.py
â”œâ”€â”€ configs/
â”‚   â”œâ”€â”€ detr_baseline.yaml
â”‚   â””â”€â”€ detr_small_obj.yaml
â”œâ”€â”€ data/
â”‚   â””â”€â”€ traffic_coco/          # COCO æ ¼å¼æ•°æ®é›†
â”œâ”€â”€ outputs/
â”‚   â”œâ”€â”€ logs/
â”‚   â”œâ”€â”€ weights/
â”‚   â””â”€â”€ results/
â”œâ”€â”€ experiments/               # å®éªŒä¸è®ºæ–‡å›¾è¡¨ï¼ˆå¯é€‰ï¼‰
â”œâ”€â”€ README.md
â””â”€â”€ develop.md
```

---

## 4. æ•°æ®é›†ç­–ç•¥ä¸ç›®å½•è§„åˆ’

æœ¬é¡¹ç›®ä»¥ BDD100K ä¸ºä¸»æˆ˜åœºï¼ŒCCTSDB / TT100K ä½œä¸ºå°ç›®æ ‡å¼ºåŒ–ä¸è·¨æ•°æ®é›†æ³›åŒ–è¯„ä¼°ï¼ŒLISA Traffic Light è§†æ—¶é—´èµ„æºå†³å®šæ˜¯å¦åŠ å…¥ã€‚æ‰€æœ‰æ•°æ®ç»Ÿä¸€è½¬æ¢ä¸º COCO JSONã€‚

### 4.1 æ•°æ®é›†åˆ†å·¥

- **BDD100K**ï¼šä¸»æ£€æµ‹ä¸å°ç›®æ ‡å®éªŒï¼ˆbaseline + small_objï¼‰ï¼Œå¤šç›®æ ‡è·Ÿè¸ªæŒ‡æ ‡ï¼ˆHOTA/MOTA/IDF1ï¼‰ï¼ŒStreamlit demo è§†é¢‘æ¥æºã€‚
- **CCTSDB**ï¼šä¸­å›½äº¤é€šæ ‡å¿—å°ç›®æ ‡ä¸“é¡¹ï¼ŒåŸºäº BDD100K é¢„è®­ç»ƒæƒé‡å¾®è°ƒæˆ–ç‹¬ç«‹è®­ç»ƒï¼Œå…³æ³¨ AP_smallï¼›å¯åšè·¨æ•°æ®é›†è¿ç§»æ•…äº‹ã€‚
- **TT100K**ï¼šå¤§è§„æ¨¡å°ç›®æ ‡è·¯ç‰Œï¼ŒéªŒè¯å°ç›®æ ‡ä¼˜åŒ–çš„æ³›åŒ–ï¼›å¯ç›´æ¥æµ‹è¯•æˆ–çŸ­æš‚å¾®è°ƒã€‚
- **LISA Traffic Lightï¼ˆå¯é€‰ï¼‰**ï¼šçº¢ç»¿ç¯ç»†ç²’åº¦/å°ç›®æ ‡åŠ åˆ†å®éªŒã€‚

### 4.2 ç›®å½•ä¸ COCO è½¬æ¢çº¦å®š

```text
data/
  raw/
    bdd100k/
    cctsdb/
    tt100k/
    lisa_traffic_light/         # å¯é€‰
  traffic_coco/
    bdd100k_det/
      images/{train,val,test}
      annotations/{instances_train.json, instances_val.json, instances_test.json}
    cctsdb_det/
      images/{train,val}
      annotations/{instances_train.json, instances_val.json}
    tt100k_det/
      images/{train,val}
      annotations/{instances_train.json, instances_val.json}
    lisa_light_det/             # å¯é€‰
```

å»ºè®®åœ¨ `tools/convert_to_coco.py` ä¸‹å®ç°ç‹¬ç«‹è½¬æ¢å‡½æ•°ï¼ˆ`convert_bdd100k_to_coco` / `convert_cctsdb_to_coco` / `convert_tt100k_to_coco`ï¼‰ï¼Œç»Ÿä¸€è¾“å‡ºåˆ°ä¸Šè¿°ç›®å½•ã€‚

### 4.3 ç±»åˆ«æ˜ å°„æ–¹æ¡ˆï¼ˆç¤ºä¾‹ï¼‰

åœ¨ `configs/classes.yaml` ç»´æŠ¤å…¨å±€ coarse ç±»åˆ«ï¼Œè®­ç»ƒ/è¯„æµ‹æ—¶é€šè¿‡ DataLoader æ˜ å°„ï¼š

```yaml
COARSE_CLASSES:
  0: vehicle        # car, bus, truck ç­‰
  1: traffic_sign   # å„ç§è·¯ç‰Œ/æ ‡å¿—
  2: traffic_light  # çº¢ç»¿ç¯
```

- **BDD100K**ï¼š`car/bus/truck` â†’ vehicleï¼›`traffic sign` â†’ traffic_signï¼›`traffic light` â†’ traffic_lightï¼ˆå¯é€‰ bike/motor æ˜¯å¦å¹¶å…¥ vehicleï¼‰ã€‚
- **CCTSDB**ï¼šä¸‰å¤§ç±»ï¼ˆæŒ‡ç¤º/ç¦æ­¢/è­¦å‘Šï¼‰å…¨éƒ¨æ˜ å°„ä¸º traffic_signï¼›éœ€è¦ç»†ç²’åº¦æ—¶ä¿ç•™åŸç±»ã€‚
- **TT100K**ï¼š200+ è·¯ç‰Œå…¨éƒ¨æ˜ å°„ä¸º traffic_signï¼›å¯é€‰é•¿å°¾åˆ†ææ—¶ä¿ç•™åŸç±»ã€‚
- **LISA TLï¼ˆå¯é€‰ï¼‰**ï¼š14 ç±»ä¿¡å·çŠ¶æ€å…¨éƒ¨æ˜ å°„ä¸º traffic_lightï¼›ç»†ç²’åº¦å®éªŒä¿ç•™åŸç±»ã€‚

### 4.4 è®­ç»ƒä¸å®éªŒé¡ºåºï¼ˆæ‰§è¡Œå»ºè®®ï¼‰

1) **BDD100K ä¸»å¹²**ï¼šå…ˆè·‘ baselineï¼Œå†è·‘ small_objï¼Œå¤šå°ºåº¦ä¸é«˜åˆ†è¾¨ç‡ç‰¹å¾å¼€å…³ï¼Œå…³æ³¨ AP_smallï¼›åœ¨ BDD100K MOT ä¸Šè¯„æµ‹ HOTA/MOTA/IDF1ã€‚
2) **å°ç›®æ ‡ä¸“é¡¹**ï¼šåŸºäº BDD100K é¢„è®­ç»ƒæƒé‡ï¼Œå¯¹ CCTSDB / TT100K å¾®è°ƒæˆ–ç›´æ¥æµ‹è¯•ï¼ŒæŠ¥å‘Š AP_small æå‡ï¼›æ—¶é—´å……è¶³å¯ç‹¬ç«‹è®­ç»ƒä¸€ç‰ˆä½œå¯¹ç…§ã€‚
3) **å¯é€‰æ‰©å±•**ï¼šLISA traffic light ç»†ç²’åº¦æˆ–å°ç›®æ ‡å®éªŒã€‚
4) **å¯è§†åŒ–ä¸ç­”è¾©**ï¼šStreamlit ä½¿ç”¨ BDD100K æˆ–è‡ªé‡‡è§†é¢‘ï¼Œæ”¯æŒä¹¦ç­¾/å›æ”¾/å¯¼å‡ºï¼›å¼•ç”¨ä¸Šè¿°æ•°æ®é›†äº§å‡ºçš„æŒ‡æ ‡ä¸æ ·ä¾‹ã€‚

---

## 5. å¿«é€Ÿå¼€å§‹

### 4.1 ç¯å¢ƒå‡†å¤‡

æ¨èä½¿ç”¨ Condaï¼š

```bash
conda create -n detr_traffic python=3.10
conda activate detr_traffic

pip install -r requirements.txt
```

ç¡®ä¿ `requirements.txt` ä¸­åŒ…å«ï¼š

* `torch`, `torchvision`
* `streamlit`
* `opencv-python`
* `pycocotools`
* `trackeval`
* ä»¥åŠ `numpy`, `tqdm`, `pyyaml` ç­‰åŸºç¡€ä¾èµ–ã€‚

### 4.2 æ•°æ®é›†å‡†å¤‡

1. å°†åŸå§‹äº¤é€šåœºæ™¯æ•°æ®é›†ï¼ˆå¦‚ BDD100K / TT100Kï¼‰æ”¾å…¥ `data/raw/`ï¼›
2. ä½¿ç”¨è„šæœ¬è½¬æ¢ä¸º COCO æ ¼å¼ï¼š

```bash
python tools/convert_to_coco.py \
  --src data/raw \
  --dst data/traffic_coco
```

3. è½¬æ¢å®Œæˆåï¼Œç¡®è®¤ `data/traffic_coco/` ä¸‹å­˜åœ¨ï¼š

* `images/train`, `images/val`ï¼›
* `annotations/instances_train.json`, `annotations/instances_val.json`ã€‚

### 4.3 æ¨¡å‹æƒé‡

* æ–¹å¼ä¸€ï¼šä½¿ç”¨å®˜æ–¹ Deformable DETR é¢„è®­ç»ƒæƒé‡ä½œä¸ºåˆå§‹åŒ–ï¼›
* æ–¹å¼äºŒï¼šåœ¨æœ¬é¡¹ç›®æ•°æ®é›†ä¸Šä»å¤´è®­ç»ƒæˆ–å¾®è°ƒï¼Œæƒé‡ä¿å­˜åœ¨ `outputs/weights/`ã€‚

é…ç½®æ–‡ä»¶ä¸­é€šè¿‡å­—æ®µï¼ˆå¦‚ `MODEL.WEIGHTS` æˆ–è‡ªå®šä¹‰ `weights_path`ï¼‰æŒ‡å®šæƒé‡è·¯å¾„ã€‚

### 4.4 è¿è¡Œå¯è§†åŒ–ç³»ç»Ÿ

```bash
streamlit run app/app_streamlit.py
```

å¯åŠ¨ååœ¨æµè§ˆå™¨è®¿é—®ï¼š

* é»˜è®¤ï¼š`http://localhost:8501`

å³å¯ï¼š

* ä¸Šä¼ è§†é¢‘æ–‡ä»¶è¿›è¡Œæ£€æµ‹ä¸è·Ÿè¸ªå±•ç¤ºï¼›
* è°ƒæ•´ç½®ä¿¡åº¦é˜ˆå€¼ã€è·Ÿè¸ªç®—æ³•ç±»å‹ã€å¯è§†åŒ–é€‰é¡¹ï¼›
* ä¸ºè¯¯æ£€/æ¼æ£€å¸§æ·»åŠ ä¹¦ç­¾å¹¶å›æ”¾åˆ†æã€‚

### 4.5 ç¦»çº¿æ¨ç†ä¸è¯„æµ‹

* æ£€æµ‹è¯„æµ‹ï¼ˆmAP / AP_smallï¼‰ï¼š

```bash
python tools/eval_detr.py \
  --config configs/detr_small_obj.yaml \
  --eval-set val
```

* ç”Ÿæˆè·Ÿè¸ªç»“æœå¹¶è¯„æµ‹ï¼ˆHOTA / IDF1 / MOTAï¼‰ï¼š

```bash
# ç”Ÿæˆè·Ÿè¸ªç»“æœ
python tools/inference_tracks.py \
  --config configs/detr_small_obj.yaml \
  --output outputs/results/tracks/

# è®¡ç®— MOT æŒ‡æ ‡
python tools/eval_mot.py \
  --gt data/mot_gt \
  --res outputs/results/tracks
```

* ç³»ç»Ÿæ€§èƒ½åŸºå‡†æµ‹è¯•ï¼ˆFPS / Latency / VRAMï¼‰ï¼š

```bash
python tools/benchmark_system.py \
  --config configs/detr_small_obj.yaml \
  --input data/test_video.mp4
```

---

## 6. æ•°æ®å¯¼å‡ºè§„èŒƒï¼ˆSchemaï¼‰

ç³»ç»Ÿå¯¼å‡ºçš„ `result.csv` é»˜è®¤é‡‡ç”¨ä»¥ä¸‹å­—æ®µç»“æ„ï¼š

| å­—æ®µå        | ç±»å‹     | è¯´æ˜                          |
| ---------- | ------ | --------------------------- |
| frame_id   | int    | è§†é¢‘å¸§å·ï¼ˆä» 1 å¼€å§‹ï¼‰                |
| timestamp  | float  | ç›¸å¯¹æ—¶é—´æˆ³ï¼ˆå•ä½ï¼šç§’ï¼‰                 |
| track_id   | int    | å…¨å±€å”¯ä¸€è·Ÿè¸ª IDï¼Œ-1 è¡¨ç¤ºæœªå‚ä¸è·Ÿè¸ª        |
| class_id   | int    | ç±»åˆ«ç´¢å¼•ï¼ˆ0: vehicle, 1: sign ç­‰ï¼‰ |
| class_name | str    | ç±»åˆ«åç§°                        |
| conf       | float  | æ£€æµ‹ç½®ä¿¡åº¦ï¼ˆ0.0â€“1.0ï¼‰              |
| bbox_xywh  | string | "[cx, cy, w, h]" æ ¼å¼åƒç´ åæ ‡     |

ç¤ºä¾‹ï¼š

```csv
frame_id,timestamp,track_id,class_id,class_name,conf,bbox_xywh
120,4.00,7,1,traffic_sign,0.83,"[512.3, 240.5, 34.2, 36.8]"
```

è¯¥ Schema ä¸è®ºæ–‡ä¸­â€œæ•°æ®ç®¡çº¿ä¸è½åœ°å­—æ®µâ€ç« èŠ‚ä¿æŒä¸€è‡´ï¼Œå¯ç›´æ¥ç”¨äºå®éªŒæ•°æ®åˆ†æä¸å›¾è¡¨ç»˜åˆ¶ã€‚

---

## 7. å®éªŒå‘½åè§„èŒƒ

ä¸ºæ–¹ä¾¿è®ºæ–‡æ’å›¾ä¸å¯¹æ¯”å®éªŒï¼Œå»ºè®®å¯¹è¾“å‡ºç»“æœé‡‡ç”¨ç»Ÿä¸€å‘½åçº¦å®šï¼š

* `baseline_run/`ï¼šåŸå§‹ Deformable DETRï¼Œæ— å°ç›®æ ‡ä¸“é¡¹ä¼˜åŒ–ï¼›
* `small_obj_run/`ï¼šå¯ç”¨å¤šå°ºåº¦ç‰¹å¾ä¸å°ç›®æ ‡å¢å¼ºé…ç½®ï¼›
* `tracker_byte_run/`ï¼šä»¥ ByteTrack ä½œä¸ºä¸»è·Ÿè¸ªå™¨ï¼›
* `tracker_ocsort_run/`ï¼šä»¥ OC-SORT ä½œä¸ºä¸»è·Ÿè¸ªå™¨ã€‚

å…¸å‹ç›®å½•ç»“æ„ï¼š

```text
outputs/
  baseline_run/
  small_obj_run/
  tracker_byte_run/
  tracker_ocsort_run/
```

åœ¨è®ºæ–‡æ’°å†™æ—¶ï¼Œå¯ç›´æ¥å¼•ç”¨ä¸Šè¿°å‘½åå¯¹åº”çš„å®éªŒç»“æœã€‚

---

## 8. ä¸è®ºæ–‡ç« èŠ‚çš„å¯¹åº”å…³ç³»

* **ç¬¬ 3 ç«  ç³»ç»Ÿè®¾è®¡**ï¼š

  * å¯¹åº” README ä¸­çš„é¡¹ç›®æ¦‚è§ˆã€ç³»ç»ŸåŠŸèƒ½ä¸æ¶æ„è®¾è®¡éƒ¨åˆ†ï¼›
* **ç¬¬ 4 ç«  ç³»ç»Ÿå®ç°**ï¼š

  * å¯¹åº” `develop.md` ä¸­çš„æ¨¡å—å®ç°ä¸ä»£ç ç»“æ„è¯´æ˜ï¼›
* **ç¬¬ 5 ç«  å®éªŒéªŒè¯**ï¼š

  * å¯¹åº” `tools/` ä¸­çš„è¯„æµ‹è„šæœ¬ä¸ `experiments/` ä¸­ä¿å­˜çš„å®éªŒè®°å½•ä¸å›¾è¡¨ã€‚

é€šè¿‡æœ¬ä»“åº“å¯ä»¥å®Œæ•´å¤ç°è®ºæ–‡ä¸­çš„æ£€æµ‹æ€§èƒ½ã€å°ç›®æ ‡æŒ‡æ ‡ã€è·Ÿè¸ªæŒ‡æ ‡ä»¥åŠç³»ç»Ÿæ€§èƒ½è¯„ä¼°ç»“æœã€‚
