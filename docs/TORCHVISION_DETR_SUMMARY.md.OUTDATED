# Torchvision DETR å®ç°æ€»ç»“

## ğŸ“‹ å·²å®Œæˆå·¥ä½œ

### 1. æ ¸å¿ƒè®­ç»ƒè„šæœ¬
**æ–‡ä»¶**: `tools/train_detr_torchvision.py`

**åŠŸèƒ½**:
- âœ… å®Œæ•´è®­ç»ƒå¾ªç¯ï¼ˆtrain + evalï¼‰
- âœ… Checkpoint ä¿å­˜/æ¢å¤ï¼ˆmodel + optimizer çŠ¶æ€ï¼‰
- âœ… AMP æ··åˆç²¾åº¦è®­ç»ƒ
- âœ… COCO è¯„ä¼°ï¼ˆmAP/AP_small ç­‰æŒ‡æ ‡ï¼‰
- âœ… æ—¥å¿—è®°å½•ï¼ˆJSON æ ¼å¼ï¼‰
- âœ… æ”¯æŒæ•°æ®å­é›†ï¼ˆè°ƒè¯•ç”¨ï¼‰

**å…³é”®ä¼˜åŒ–**:
```python
# C++ å›¾åƒè§£ç 
from torchvision.io import read_image
img = read_image(str(img_path), mode=ImageReadMode.RGB).float() / 255.0

# ä¼˜åŒ–çš„ DataLoader
loader = DataLoader(
    dataset,
    batch_size=16,
    num_workers=12,          # 5090 è°ƒä¼˜
    prefetch_factor=2,       # é¢„å– 2 æ‰¹æ¬¡
    pin_memory=True,         # é”é¡µå†…å­˜
    persistent_workers=True, # å¤ç”¨ worker
)

# non_blocking ä¼ è¾“
images = [img.to(device, non_blocking=True) for img in images]

# æ€§èƒ½ä¼˜åŒ–
torch.backends.cudnn.benchmark = True
torch.set_float32_matmul_precision("high")  # PyTorch 2.0+
```

### 2. é…ç½®æ–‡ä»¶
**æ–‡ä»¶**: `configs/detr_torchvision.yaml`

**å†…å®¹**:
- æ•°æ®é›†è·¯å¾„é…ç½®
- æ¨¡å‹å‚æ•°ï¼ˆnum_classes, pretrained_backboneï¼‰
- å›¾åƒå°ºå¯¸ï¼ˆmin_size=800, max_size=1333ï¼‰
- è®­ç»ƒè¶…å‚æ•°ï¼ˆlr, batch_size, epochsï¼‰
- DataLoader ä¼˜åŒ–å‚æ•°
- æ€§èƒ½ä¼˜åŒ–å¼€å…³

### 3. å†’çƒŸæµ‹è¯•è„šæœ¬
**æ–‡ä»¶**: `tools/smoke_test_torchvision.py`

**åŠŸèƒ½**:
- âœ… 10 æ­¥è®­ç»ƒéªŒè¯é“¾è·¯
- âœ… Checkpoint ä¿å­˜/åŠ è½½æµ‹è¯•
- âœ… æ¨ç†æ¨¡å¼æµ‹è¯•
- âœ… Loss è¶‹åŠ¿æ£€æŸ¥

**ç”¨æ³•**:
```bash
python tools/smoke_test_torchvision.py \
  --train-img data/traffic_coco/bdd100k_det/images/train \
  --train-ann data/traffic_coco/bdd100k_det/annotations/instances_train.json
```

### 4. æ•°æ®åŠ è½½æ€§èƒ½æµ‹è¯•
**æ–‡ä»¶**: `tools/benchmark_dataloader.py`

**åŠŸèƒ½**:
- âœ… æµ‹è¯• DataLoader ååé‡
- âœ… éªŒè¯æ•°æ®æ ¼å¼æ­£ç¡®æ€§
- âœ… å¯¹æ¯”ä¸åŒ workers/prefetch_factor é…ç½®

**ç”¨æ³•**:
```bash
python tools/benchmark_dataloader.py \
  --batch-size 16 --num-workers 12 --prefetch-factor 2
```

### 5. ä¸€é”®å¯åŠ¨è„šæœ¬
**æ–‡ä»¶**: `tools/run_torchvision_training.sh`

**åŠŸèƒ½**:
- âœ… äº¤äº’å¼é€‰æ‹©è®­ç»ƒæ¨¡å¼
- âœ… è‡ªåŠ¨æ£€æŸ¥è™šæ‹Ÿç¯å¢ƒ
- âœ… æ•°æ®é›†å®Œæ•´æ€§æ£€æŸ¥
- âœ… ä¸‰ç§é¢„è®¾æ¨¡å¼ï¼ˆå†’çƒŸ/å¿«é€Ÿ/å®Œæ•´ï¼‰

**ç”¨æ³•**:
```bash
./tools/run_torchvision_training.sh
# é€‰æ‹©æ¨¡å¼ 1/2/3
```

### 6. å¼€å‘æ–‡æ¡£
**æ–‡ä»¶**: `docs/TORCHVISION_DETR_GUIDE.md`

**å†…å®¹**:
- æ”¹è¿›è¦ç‚¹è¯´æ˜
- å¿«é€Ÿå¼€å§‹æŒ‡å—
- å‚æ•°è¯´æ˜
- è¾“å‡ºç»“æ„
- æ€§èƒ½é¢„æœŸ
- è°ƒè¯•å»ºè®®
- å¸¸è§é—®é¢˜

## ğŸ¯ è®¾è®¡ç›®æ ‡è¾¾æˆæƒ…å†µ

### âœ… å·²å®ç°
1. **C++ å›¾åƒè§£ç **: ä½¿ç”¨ `torchvision.io.read_image` æ›¿ä»£ PIL
2. **DataLoader ä¼˜åŒ–**: workers=12, prefetch=2, pin_memory, persistent_workers
3. **è®­ç»ƒåŠ é€Ÿ**: non_blocking, cudnn.benchmark, matmul_precision
4. **æ ‡ç­¾æ˜ å°„**: COCO category_id â†’ è¿ç»­ [0..N-1]
5. **åˆ†è¾¨ç‡ä¿æŒ**: min_size=800, max_size=1333ï¼ˆä¿æŒçºµæ¨ªæ¯”ï¼‰
6. **å®Œæ•´è®­ç»ƒåŠŸèƒ½**: checkpoint, resume, eval, logging
7. **AMP æ”¯æŒ**: bf16/fp16 æ··åˆç²¾åº¦

### ğŸ“Š æ€§èƒ½é¢„æœŸï¼ˆRTX 5090ï¼‰
- **åŸå®ç°**: 2.48 it/sï¼ˆPIL + HF Processorï¼‰
- **ç›®æ ‡**: 3-4 it/s
- **ä¼˜åŒ–å¹…åº¦**: ~30-50% æå‡

### ğŸ”„ å¯¹æ¯” develop.md Â§ 3.11
å®Œå…¨ç¬¦åˆ develop.md ä¸­çš„æ”¹è¿›è¦æ±‚ï¼š
- âœ… åˆ‡æ¢åˆ° torchvision DETR
- âœ… ä¿æŒåˆ†è¾¨ç‡/ç²¾åº¦
- âœ… C++ è§£ç ä¼˜åŒ–
- âœ… DataLoader è°ƒä¼˜
- âœ… æ”¯æŒ checkpoint/eval

## ğŸ“ æ–‡ä»¶æ¸…å•

```
detr_traffic_analysis/
â”œâ”€â”€ tools/
â”‚   â”œâ”€â”€ train_detr_torchvision.py          # ä¸»è®­ç»ƒè„šæœ¬
â”‚   â”œâ”€â”€ smoke_test_torchvision.py          # å†’çƒŸæµ‹è¯•
â”‚   â”œâ”€â”€ benchmark_dataloader.py            # DataLoader æ€§èƒ½æµ‹è¯•
â”‚   â””â”€â”€ run_torchvision_training.sh        # ä¸€é”®å¯åŠ¨è„šæœ¬
â”œâ”€â”€ configs/
â”‚   â””â”€â”€ detr_torchvision.yaml              # è®­ç»ƒé…ç½®
â””â”€â”€ docs/
    â”œâ”€â”€ TORCHVISION_DETR_GUIDE.md          # å¼€å‘æ–‡æ¡£
    â””â”€â”€ TORCHVISION_DETR_SUMMARY.md        # æœ¬æ–‡ä»¶
```

## ğŸš€ å¿«é€Ÿå¼€å§‹ï¼ˆ3 æ­¥ï¼‰

### æ­¥éª¤ 1: å†’çƒŸæµ‹è¯•
```bash
python tools/smoke_test_torchvision.py
```
**éªŒè¯**: é“¾è·¯æ­£å¸¸ï¼Œloss ä¸‹é™

### æ­¥éª¤ 2: DataLoader æ€§èƒ½æµ‹è¯•
```bash
python tools/benchmark_dataloader.py --num-workers 12
```
**éªŒè¯**: ååé‡ç¬¦åˆé¢„æœŸ

### æ­¥éª¤ 3: å¿«é€Ÿè®­ç»ƒï¼ˆå­é›†ï¼‰
```bash
python tools/train_detr_torchvision.py \
  --train-img data/traffic_coco/bdd100k_det/images/train \
  --train-ann data/traffic_coco/bdd100k_det/annotations/instances_train.json \
  --val-img data/traffic_coco/bdd100k_det/images/val \
  --val-ann data/traffic_coco/bdd100k_det/annotations/instances_val.json \
  --subset 2000 --num-epochs 10 --amp --pretrained-backbone
```
**éªŒè¯**: it/s è¾¾åˆ° 3-4ï¼ŒmAP æ­£å¸¸

## ğŸ“ˆ åç»­å·¥ä½œ

### ä¼˜å…ˆçº§ P0ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰
- [ ] å®Œæ•´è®­ç»ƒéªŒè¯ï¼ˆå…¨éƒ¨æ•°æ®ï¼‰
- [ ] æ€§èƒ½å¯¹æ¯”æŠ¥å‘Šï¼ˆvs åŸå®ç°ï¼‰
- [ ] mAP/AP_small æŒ‡æ ‡éªŒè¯

### ä¼˜å…ˆçº§ P1ï¼ˆå¢å¼ºåŠŸèƒ½ï¼‰
- [ ] å­¦ä¹ ç‡è°ƒåº¦å™¨ï¼ˆCosine/Stepï¼‰
- [ ] Gradient clipping
- [ ] å¤šå°ºåº¦è®­ç»ƒï¼ˆæ•°æ®å¢å¼ºï¼‰
- [ ] EMAï¼ˆExponential Moving Averageï¼‰

### ä¼˜å…ˆçº§ P2ï¼ˆé«˜çº§ä¼˜åŒ–ï¼‰
- [ ] DDP å¤šå¡è®­ç»ƒ
- [ ] ç¼–è¯‘åŠ é€Ÿï¼ˆtorch.compileï¼‰
- [ ] æ•°æ®æ ¼å¼ä¼˜åŒ–ï¼ˆFFCV/LMDBï¼‰

## ğŸ› å·²çŸ¥é—®é¢˜ & è§£å†³æ–¹æ¡ˆ

### é—®é¢˜ 1: ç±»åˆ«æ˜ å°„
**ç°è±¡**: COCO category_id ä¸è¿ç»­  
**è§£å†³**: åœ¨ Dataset ä¸­å»ºç«‹ `cat_id_map` æ˜ å°„åˆ° [0..N-1]

### é—®é¢˜ 2: Resize ç­–ç•¥
**ç°è±¡**: torchvision DETR éœ€è¦ç‰¹å®š resize é€»è¾‘  
**è§£å†³**: å®ç° `_resize()` æ–¹æ³•ï¼Œä¿æŒçºµæ¨ªæ¯”

### é—®é¢˜ 3: Target æ ¼å¼
**ç°è±¡**: torchvision DETR éœ€è¦å­—å…¸æ ¼å¼ target  
**è§£å†³**: è¿”å› `{"boxes", "labels", "image_id", "area", "iscrowd"}`

## ğŸ“Š æ€§èƒ½è°ƒä¼˜å»ºè®®

### DataLoader å‚æ•°
| å‚æ•° | RTX 5090 | RTX 3090 | è¯´æ˜ |
|------|----------|----------|------|
| num_workers | 12-16 | 8-12 | CPU æ ¸å¿ƒæ•°ç›¸å…³ |
| prefetch_factor | 2-4 | 2-3 | å†…å­˜æ¶ˆè€—æ¢é€Ÿåº¦ |
| batch_size | 16-24 | 8-16 | æ˜¾å­˜é™åˆ¶ |

### è®­ç»ƒç­–ç•¥
- **AMP**: å¿…å¼€ï¼ˆbf16 ä¼˜å…ˆï¼‰
- **cudnn.benchmark**: å¿…å¼€
- **persistent_workers**: å¿…å¼€ï¼ˆworkers > 0ï¼‰
- **pin_memory**: å¿…å¼€

## ğŸ“ ä»£ç ç¤ºä¾‹

### å®Œæ•´è®­ç»ƒå‘½ä»¤
```bash
python tools/train_detr_torchvision.py \
  --train-img data/traffic_coco/bdd100k_det/images/train \
  --train-ann data/traffic_coco/bdd100k_det/annotations/instances_train.json \
  --val-img data/traffic_coco/bdd100k_det/images/val \
  --val-ann data/traffic_coco/bdd100k_det/annotations/instances_val.json \
  --num-classes 3 \
  --batch-size 16 \
  --num-workers 12 \
  --prefetch-factor 2 \
  --min-size 800 \
  --max-size 1333 \
  --num-epochs 50 \
  --lr 5e-5 \
  --weight-decay 1e-4 \
  --eval-interval 5 \
  --amp \
  --pretrained-backbone \
  --output-dir outputs/detr_torchvision_full
```

### æ¢å¤è®­ç»ƒ
```bash
python tools/train_detr_torchvision.py \
  [... åŒä¸Šå‚æ•° ...] \
  --resume outputs/detr_torchvision_full/last.pth
```

### ä»…è¯„ä¼°
```bash
# ä½¿ç”¨è®­ç»ƒè„šæœ¬çš„ epoch 0ï¼ˆè·³è¿‡è®­ç»ƒï¼‰
python tools/train_detr_torchvision.py \
  --val-img data/traffic_coco/bdd100k_det/images/val \
  --val-ann data/traffic_coco/bdd100k_det/annotations/instances_val.json \
  --num-classes 3 \
  --num-epochs 0 \
  --resume outputs/detr_torchvision_full/best.pth
```

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [develop.md](develop.md) Â§ 3.11 - æ€§èƒ½ç“¶é¢ˆä¸åˆ‡æ¢è®°å½•
- [TORCHVISION_DETR_GUIDE.md](TORCHVISION_DETR_GUIDE.md) - å®Œæ•´å¼€å‘æŒ‡å—
- [torchvision DETR æ–‡æ¡£](https://pytorch.org/vision/stable/models/detr.html)

---

**ç‰ˆæœ¬**: v1.0  
**æ—¥æœŸ**: 2026-01-06  
**ç»´æŠ¤è€…**: GitHub Copilot
